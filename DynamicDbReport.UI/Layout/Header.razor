@implements IDisposable

@using DynamicDbReport.DTO.Models.SQLModels
@using DynamicDbReport.DTO.Shared
@using DynamicDbReport.UI.PrivateServices
@inject ILocalStorageService localStorage
@inject IMessageService messageService
@inject AuthenticationStateProvider _authenticationStateProvider
@inject NavigationManager _navigationManager


<FluentHeader Class="siteheader">
    <FluentNavLink Href="/">
        <FluentPersona Name="@(loginData.Engine == EngineName.None ? "Not connected" : $"{loginData.Engine.ToString()} - {loginData.ServerAddress}({loginData.Username})")"
                       Status="@(loginData.Engine == EngineName.None? PresenceStatus.Unknown: PresenceStatus.Available)"
                       StatusSize="PresenceBadgeSize.Tiny"
                       Image="/icon-192.png"
                       ImageSize="32px">
        </FluentPersona>
    </FluentNavLink>
    <FluentSpacer />

    <AuthorizeView>
        <Authorized>

            <FluentSelect AriaLabel="Databases" SelectedOption="@loginData.DbName" Items="@dbNames" TOption="string" @onchange="((e)=> ChangeDB(e.Value.ToString()))" Style="width:30px;margin:0 5px;" />
                
            <FluentButton OnClick="ChangeConnection" Title="Change connection"><FluentIcon Value="@(new Icons.Regular.Size20.Connector())" Color="Color.Neutral" Title="Change connection" /></FluentButton>
        </Authorized>
    </AuthorizeView>

</FluentHeader>


@code {
    [Inject] private HttpClientHelper http { get; set; }
    [Inject] private IToastService toast { get; set; }

    List<string> dbNames = [];
    string currentDB = "";
    CredentialRequest loginData = new();

    protected override async Task OnInitializedAsync()
    {
        messageService.OnMessageItemsUpdated += UpdateData;
        await CheckToUpdate();
    }

    private async Task CheckToUpdate()
    {
        if (await localStorage.ContainKeyAsync("dbMember"))
        {
            loginData = await localStorage.GetItemAsync<CredentialRequest>("dbMember");
        }
        await FetchDbList();

        StateHasChanged();
    }

    private async Task FetchDbList()
    {
        var fetchData = await http.HttpClientReceiveAsync<DatabaseNameListResponse>(HttpMethod.Post, "SQLFunctions/DBNameList", loginData.ToJsonString());
        if (fetchData?.ResponseData is null || !fetchData.SuccessAction || fetchData.ResponseData.Count == 0)
        {
            toast.ShowError(fetchData?.ErrorException?.ErrorMessage ?? "Cannot fetch dbs");
            return;
        }

        dbNames = fetchData.ResponseData;
    }

    private async Task ChangeDB(string db)
    {
        loginData.DbName = db;
        await localStorage.SetItemAsync("dbMember", loginData);
    }

    private async Task ChangeConnection()
    {
        loginData = new();
        await ((PrivateServices.CustomAuthentication)_authenticationStateProvider).MarkUserAsLoggedOut();
        _navigationManager.NavigateTo("/Auth/Login");
    }

    public void Dispose()
    {
        messageService.OnMessageItemsUpdated -= UpdateData;
    }

    private void UpdateData()
    {
        CheckToUpdate();
        InvokeAsync(StateHasChanged);
    }

}